#!/usr/bin/octave -q

# Create 
#
template = [ ...
 '%%!test\n', ...
 '%%! display(''Test %d...'');\n', ...
 '%%! graphics_toolkit gnuplot\n', ...
 '%%! try\n', ...
 '%%!   out = ACID(%d);\n', ...
 '%%! catch e\n', ...
 '%%!   error(''Exception in ACID:\\n%%s'', e.message);\n', ...
 '%%! end\n', ...
 '%%! display(out.description);\n', ...
 '%%! if ~(isfield(out, ''skip'') && out.skip)\n', ...
 '%%!   outputFile = ''data/converted/test%d-converted.tex'';\n', ...
 '%%!   try\n', ...
 '%%!     matlab2tikz( ...\n', ...
 '%%!       ''filename'', outputFile, ...\n', ...
 '%%!       ''width'', ''5cm'', ...\n', ...
 '%%!       ''showInfo'', false, ...\n', ...
 '%%!       ''checkForUpdates'', false, ...\n', ...
 '%%!       ''dataPath'', ''data/converted/'', ...\n', ...
 '%%!       ''standalone'', true ...\n', ...
 '%%!       );\n', ...
 '%%!   catch e\n', ...
 '%%!     error(''Exception in matlab2tikz:\\n%%s'', e.message);\n', ...
 '%%!   end\n', ...
 '%%!   type(outputFile);\n', ...
 '%%!   %%md5sum(outputFile)\n', ...
 '%%!   assert(md5sum(outputFile), out.md5);\n', ...
 '%%! end\n', ...
 '%%!\n' ...
 ];

# Create test entries for all tests
testfile = 'testlist.m';
fh = fopen(testfile, 'w');
testcases = ACID(0);
for k = 1:length(testcases)
  fprintf(fh, template, k, k, k);
end
fclose(fh);

# Actually run the tests.
# Can't use the [n, max] return arguments
# <https://www.gnu.org/software/octave/doc/interpreter/Test-Functions.html>
# since they don't account for exceptions in tests.
addpath('../src/');
success = test(testfile);

if success
  printf('Tests successful.');
  ierr = 0;
else
  ierr = 1;
end
exit(ierr);
